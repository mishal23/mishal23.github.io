<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 5.10.0"/><meta name="theme-color" content="#2d2a2a"/><style data-href="/styles.d879223583f07a003c31.css" data-identity="gatsby-global-css">*{box-sizing:border-box}body,html{margin:0;padding:0}body{background:#f8f8f8;color:#333;font-family:Inter,sans-serif;font-size:18px;font-weight:400;line-height:1.6em}a{color:#000;text-decoration:none;word-break:break-word}a:hover{color:#06f;text-decoration:underline;text-decoration-color:#06f;text-decoration-thickness:2px}code{background:#f4f4f4;color:#000;display:inline-block;font-size:.9em;padding:3px 5px}pre code{display:block}.post .highlight{background:#f4f4f4;padding:5px}button,html,input,select,textarea{color:#333}::selection{background:#000;color:#fff;text-shadow:none}hr{border:0;border-top:1px solid #eee;display:block;height:1px;margin:15px 0;padding:0}img{max-width:100%}a img{border:none}figure{margin:0;text-align:center}fieldset{border:0;margin:0;padding:0}textarea{resize:vertical}blockquote{background:#f6f6f6;border-left:5px solid;border-color:#000;font-style:italic;padding:5px 15px}blockquote cite{font-size:70%;opacity:.8}blockquote em{font-weight:600}h1,h2,h3,h4,h5,h6{font-weight:500;line-height:1.3em;margin:45px 0 20px}h1{font-size:2.75rem}h2{font-size:2rem}h3{font-size:1.6rem}h4{font-size:1.2rem}h5{font-size:1rem}h6{font-size:.9rem}.align-center{text-align:center}.align-left{text-align:left}.align-right{text-align:right}.float-right{float:right}figure.float-right{margin:0 15px}.text-small{font-size:.875em}ul{padding-left:15px}ul.flat{margin:0;padding:0}ul.flat li{display:inline-block;list-style:none;margin-left:0}.prevent-collapse{min-height:.1rem}.post ul li{margin-bottom:10px}.highlight pre{background-color:transparent!important;margin-bottom:0;margin-top:0;padding:20px}.wrap{background:#fff;margin:0 auto;padding:60px 75px}.container{max-width:950px;min-width:320px}.header{display:flex;flex-wrap:wrap;margin-bottom:90px}.header .logo,.header nav{flex-grow:1}.header nav{line-height:1em;text-align:right}.header .logo{font-size:1.5em;font-weight:500}.header nav a{color:#06f;display:inline-block;margin-left:30px}.header nav .feed img{height:auto;width:16px}.header .site-description nav{border:none;margin:0 0 0 15px;min-width:50px;padding:0}.header .site-description nav ul svg{max-height:15px}.section .section-header{color:#999;font-size:.75rem;font-weight:600;letter-spacing:1px;margin-bottom:20px;text-transform:uppercase}.posts .post{margin-bottom:60px}.post.blurb .post-header{margin:0 0 15px}.post.blurb .title{margin:0}.post.blurb .date{color:#888}.post .content{border-bottom:1px solid #ddd;margin-bottom:30px;padding-bottom:30px}.post .content a{color:#06f;text-decoration:underline}.post .content a:hover{color:#000;text-decoration-color:#000}.post .post-header{margin-bottom:30px}.post .draft-label{background-color:#f9f2f4;border-radius:4px;color:#000;margin-left:6px;padding:2px 4px;text-decoration:none}.post .author{display:flex;font-size:.875em;line-height:1.35em;margin-top:30px}.post .author .avatar{flex:0 0 64px}.post .author img{border-radius:100%;display:inline-block;margin-right:15px;max-width:64px}.post .author .desig{color:#888}.post .author span{display:inline-block}.post .author .date{margin-top:5px}.post .author .urls{font-size:.775em}.post .author .urls a{color:#888;margin-right:5px}.projects{margin-top:60px}.projects .item{display:flex;margin-bottom:30px}.projects .name{flex:40% 1}.projects .description{flex:60% 1}.projects h3{margin:0}.projects p{margin:0 0 10px}.projects .date{color:#999;font-size:.875em}h1.intro{margin:0 0 120px}.intro .highlight{border-bottom:5px solid #06f}code[slot=code]{display:none}.description a{color:#06f;text-decoration:underline}.footer{color:#999;font-size:.75em;margin:30px 0;text-align:center}.footer a{color:#666}.footer a:hover{color:#06f}.footer .social{margin-top:5px;padding:0}.footer ul{list-style-type:none;margin:0}.footer .social li{display:inline-block;margin-right:10px}.tag-cloud{margin-top:20px}.tag-cloud a{margin-right:15px}.tags a{border:1px solid #333;border-radius:3px;color:#333;display:inline-block;font-size:.85em;line-height:20px;margin:0 10px 0 0;padding:0 6px;text-decoration:none}.pagination{display:flex;justify-content:space-between;margin:0;padding:0;text-align:left}.pagination li{display:inline-block;list-style:none;margin:0;padding:0}.pagination .page-prev{margin-right:20px;padding-right:20px}.pagination .page-item.page-prev{text-align:left}.pagination .page-item.page-next{text-align:right}div.newsletter{background:#2d2a2a;border:3px solid #2d2a2a;border-radius:5px;color:#fff;margin:1.5em auto;padding:1.5em}.newsletterform-item label{display:inline-block;font-size:1rem;margin-bottom:.5rem;max-width:100%}.newsletterform-item input{height:2.5rem;padding:0;text-indent:.75rem}.newsletterform-item textarea{height:8rem;overflow:auto;padding:.75rem}.newsletterform-item input,.newsletterform-item textarea{border:1px solid #ccc;font-size:.9rem;margin-bottom:15px;outline:0;transition:all .7s ease;width:100%}.newsletterform-item:last-child{margin:1rem 0 2rem}.newsletterform-btn{background-color:#2d2a2a;border:0;border-radius:0;color:#faf9f9;cursor:pointer;display:inherit;font-size:.8rem;letter-spacing:2px;margin:0 auto;outline:0;padding:1rem 1.5rem;text-transform:uppercase;transition:all .4s;width:100%}.newsletterform-btn:hover{background:#ccc;color:#2d2a2a}table{border-collapse:collapse;width:100%}table td,table th{border:1px solid #ddd;padding:8px}table tr:nth-child(2n){background-color:#f2f2f2}.social-icons{font-size:1.3rem}@media (max-width:940px){.wrap{padding:30px}.posts{display:block}.posts .post{margin-bottom:60px}}@media (max-width:550px){.header{display:block}.header .nav{margin-top:30px;text-align:left}.header .nav a{margin:0 30px 0 0}.float-right{float:none}figure.float-right{margin:15px 0}}code{white-space:pre-wrap}</style><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><link rel="icon" href="/favicon-32x32.png?v=83c1b219b8968b6c5ed1ac2ce0eb2933" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="192x192" href="/favicon/android-chrome-192x192.png?v=83c1b219b8968b6c5ed1ac2ce0eb2933"/><link rel="apple-touch-icon" sizes="512x512" href="/favicon/android-chrome-512x512.png?v=83c1b219b8968b6c5ed1ac2ce0eb2933"/><link rel="preconnect" href="https://www.googletagmanager.com"/><link rel="dns-prefetch" href="https://www.googletagmanager.com"/><link rel="sitemap" type="application/xml" href="/sitemap-index.xml"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><section class="container wrap"><div class="header"><div class="logo"><a href="/">Mishal Shah</a></div><nav class="nav"><a href="/about/">About</a><a href="/projects/">Projects</a><a href="/talks/">Talks</a><a href="/contact/">Contact</a></nav></div><div class="post"><div class="post-header"><h1 class="title">Running DPDK Forwarding Applications with Pktgen-DPDK</h1><div class="date">July 15, 2020</div></div><div class="content"><div><blockquote>
<p>This article is co-authored by <a href="https://www.linkedin.com/in/mehnaz-yunus/" target="_blank" rel="nofollow">Mehnaz Yunus</a></p>
</blockquote>
<p>As part of the evaluation stage of our bachelor thesis, we set up a testbed for running forwarding applications in DPDK and with Pktgen-DPDK as the traffic generator. In this blog, we aim to cover</p>
<ul>
<li>how to run Pktgen-DPDK using Lua scripts in some complex scenarios</li>
<li>how to run L2fwd, L3fwd (with exact match and longest prefix match) and L3fwd power DPDK applications.</li>
</ul>
<p>We weren't able to find a lot of resources for setting up these tests and with this blog, we aim to bridge the gap.</p>
<h2>DPDK and Pktgen-DPDK</h2>
<p>The Data Plane Development Kit is an Open source software project managed by the Linux Foundation. It provides a set of data plane libraries and network interface controller polling-mode drivers running in userspace. This way, the NIC is directly accessible by the DPDK application. The advantage of using DPDK is that you're able to utilize the link speed completely whereas, in the standard packet processing, the link goes underutilized. Thus, high performance can be achieved with DPDK.</p>
<p>Pktgen-DPDK is a software-based traffic generator powered by DPDK. Traffic generators are often used to simulate various situations and test the performance of the application.</p>
<h2>Test Setup</h2>
<p>All the tests were done with two systems, one as the <strong>System Under Test</strong> which is a bare metal server, and the other one as a <strong>generator</strong> which is a VM. The SUT has two NUMA sockets where each socket has two 14-core Intel Xeon Gold 5120 2.20 GHz processors, which has four Intel I350 10 Gigabit NICs and four Ethernet Controller X710/X557-AT 10GBASE-T NICs. The generator has two 12-core Intel Xeon Gold 5120 2.20 GHz processors, 94GB memory, and one Intel 82540EM Gigabit NIC and Ethernet Controller X710/X557-AT 10GBASE-T NICs. Each system runs Ubuntu 20.04 LTS.</p>
<p>Installation of both DPDK and Pktgen-DPDK was done by compiling from source. igb_uio kernel driver was used and 2048 huge pages were allotted. Our systems had 4 NICs so we could utilize them, if your system doesn't have that many NICs, you could use tapped interfaces. Here's a diagrammatic representation of the setup.</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/150f550dfbfab35b3699db4e3f0af1f2/169e3/Systems-DPDK.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 42.331288343558285%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAACA0lEQVR42mNgAIKYaWvF3OcfdnBZesbGc/4h66z6eh4GCGBkwAFkVj3i1Fj9OEhrw8sQrTVPozTXPFaFSzrOOx6kveLOf/UlN/9rLrn+oWb5Fs3L589NP3/x4twpU6aADGext7dnAdK8Bw8fbrh77erS1j2XXFU3vHqvvfbJf73d3/9rb3iVDzfQbtFZX81F1/6rzb34X23htXeVS3doPLh7Z8OtW7e2p6Wl8YNcCjWQ8erV630vnjw+2L37vLfS8oev1Bdc/q2z8eV/rbWPchEGLjgWqLX26X/t9c//O2x89DF9+gat65cvTblw4cJ8Ly8vCaASVhkZGU4gzX78+Mmah3duL+7afclFecXD9+qrHv13P/Dlv9GahwgX2sw5GqC35uF/n53P/7ttfvQ+d/oqrQtnz2w5c+bMLqiXmUJDQ5mBNNeBQ4em3Lh08Wjb1qM+SisevbLb9PiP1/6P/43XPshDuHDh2SDj7R/+51349T/q0IePxXPW6jy4e3vt1avXdvj6+ooDlTDLy8tzgOjLV6/2Pnv4YH/fwWveqls+vks98+N/+b3//132fUa40HvuXn3jmUdnKXTvmq8182RXy+K1ktcun3cDutAH6DJOaGyDXMh07Nhp64e3rvtWrDupprr8wVyd+Zc3Gqy8t1lv1SMPuIH/gRqQMb7kggWgqAUAo9H+Nh+ENCYAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="test setup"
        title=""
        src="/static/150f550dfbfab35b3699db4e3f0af1f2/a6d36/Systems-DPDK.png"
        srcset="/static/150f550dfbfab35b3699db4e3f0af1f2/222b7/Systems-DPDK.png 163w,
/static/150f550dfbfab35b3699db4e3f0af1f2/ff46a/Systems-DPDK.png 325w,
/static/150f550dfbfab35b3699db4e3f0af1f2/a6d36/Systems-DPDK.png 650w,
/static/150f550dfbfab35b3699db4e3f0af1f2/e548f/Systems-DPDK.png 975w,
/static/150f550dfbfab35b3699db4e3f0af1f2/3c492/Systems-DPDK.png 1300w,
/static/150f550dfbfab35b3699db4e3f0af1f2/169e3/Systems-DPDK.png 1682w"
        sizes="(max-width: 650px) 100vw, 650px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<h2>Lua Scripts with Pktgen-DPDK</h2>
<p>We used Lua scripts to automate the process of setting parameters and configuring flows in Pktgen-DPDK. Pktgen-DPDK can be run on the generator using the command shown below. It is run in promiscuous mode with the first four cores (0,1,2,3), and 4 memory channels. The Lua script for each application is mentioned using the -f option. The port mapping to cores is done as:</p>
<ul>
<li>core 1 handles port 0, 1 RX/TX</li>
<li>core 2 handles port 2, 3 RX/TX.</li>
</ul>
<blockquote>
<p>ðŸ’¡ Note: The core 0 is used for keyboard, timer, and screen output and hence shouldn't be used for port mapping. pktgen-dpdk with Lua script should be run from the pktgen directory only, otherwise it gives error.</p>
</blockquote>
<deckgo-highlight-code   >
          <code slot="code">sudo ./app/x86_64-native-linux-gcc/pktgen -c 0xf -n 4 -- -P -m 1.[0-1] -m 2.[2-3] -f /path/to/script.lua</code>
        </deckgo-highlight-code>
<h3>Situation 1: Long Running Flow for Certain Time</h3>
<p>We were required to run tests where the packets were sent for a fixed time period. Since pktgen by default doesn't support timers, we used os functions for the same.</p>
<deckgo-highlight-code language="lua"  >
          <code slot="code">local port = &quot;0&quot;;
local send_for_secs = 120;
pktgen.start(port);
local start_time = os.time();

while os.difftime(os.time(), start_time) &lt; send_for_secs do
    sleep(1);
end

pktgen.stop(port);</code>
        </deckgo-highlight-code>
<p>where send_for_secs is the time for which we want to send.</p>
<blockquote>
<p>ðŸ’¡ Note: sleep(send_for_secs) was not used because it would block Pktgen's output refreshing. So continuous check after a second and checking until the difference reaches the send_for_secs is done here.</p>
</blockquote>
<h3>Situation 2: Different Packet Size and Rate</h3>
<p>We also wanted to test with different packet sizes and rates (rate in pktgen-dpdk is to be given as a percentage of the line rate). Since changing the packet size or rate in the Lua script after every run is tedious, we ask for user input for the packet size and rate at runtime using the script below.</p>
<deckgo-highlight-code language="lua"  >
          <code slot="code">local pktSize = tonumber(pktgen.input(&quot;Enter the size of packets to send: &quot;));
if pktSize == nil then
    pktSize = 64;
end
pktgen.set(port, &quot;size&quot;, pktSize);

local rate = tonumber(pktgen.input(&quot;Enter the sending rate: &quot;));
if rate == nil then
    rate = 100;
end
pktgen.set(port, &quot;rate&quot;, rate);</code>
        </deckgo-highlight-code>
<h2>Forwarding Applications in DPDK</h2>
<p>We mention the steps to run the forwarding application and a corresponding Lua script to set relevant parameters. The command to run Pktgen-DPDK with the Lua script has been given in the previous section.</p>
<h3>l2fwd</h3>
<p>Layer 2 forwarding (switching) does not need IP addresses to work. Thus, we set only the MAC address in the packets sent from pktgen-DPDK.</p>
<ul>
<li><strong>Start the l2fwd application on the SUT:</strong> The l2fwd example can be run with the following command on the SUT. This command starts l2fwd on four cores and with four ports. The SUT has two NUMA sockets but we use only one. The even-numbered cores are on socket 0 and we use the first four cores on it, i.e, cores 0,2,4,6. Thus the core mask is given as 0x55. The port mask is 0xf as we use four ports.</li>
</ul>
<deckgo-highlight-code   >
          <code slot="code">sudo ./${RTE_SDK}/examples/l2fwd/${RTE_TARGET}/app/l2fwd -c 0x55 -n 4 -- -p 0xf</code>
        </deckgo-highlight-code>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 407px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/6fc2fd40ba12ee1e45b9e7514623bff9/0ff56/l2fwd.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 73.00613496932516%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAAsTAAALEwEAmpwYAAACWUlEQVR42oVT13LaQBTlITYuCbhgXEAUCYRYCUmg3itFQphxG7/Yk///ixyBHeclycwdze7dc9u5R5V04CwYO+2ZYUfPuCAb+UnfSnuGeSmIR7R8MviHVdZCfC8kUUdL+mbBx5tJuiZR3NWMS0H6b3A2DgoShZQW94yCjwohzrmwDL4g0hEDhHTM/L0yH22EZDlw0r6VcX5OohXrh5RiN0W0rdQ4tT4GDmexWtqkSv9OV9nKi4KEWzFFzVdzcy+mz3qxYt05bdlNaSst3rzH1dC1GhPnRnauZfd2qp+N9/GVqGc6TdG8Ety7WdBWvZaSj8OUtoOWAmhAqUCHHS1qq3DOB85y6Dq7pspgqykC5N8BKsEwqnpGlBqr1DnpmAZt3t1sWhvyB11y0CEHFPlGTY76H20/6cVGiNckvJfmb97Dk5L9jF/hQdt+S31Us/fgCdewpZYrpO24iy3yey4r1rWk1jn5dGBc8No50S4ISqFV+0rUz3njklfqI6MxwczujVw+Xcta/WtmHckwCb6LgYMh/bZqNgTY9HQYUFrOBWaDF6r9SbUnHHYnh/0vth+UVcZ6KW1iSS/6eivN36OXrZjMGQuaA9vPWo5FpH0T+stJuBr5X4ShVeXHaPadRfMohf5x0M+JfkZwhR+g6SmLA2B4wreEfSgMqhj5oASJH2dL6KQQkrCtYDykgPNFLyBepTZSa9w+fp+xDM75OKI073aaMjY4XwxdoNfjMOkZYBtqw6+yHHpJ11ixHrS8+HPP0gnzSQBTanBn8Eg7VWMlsJ0TB1r6fN1X/gUWbZuWaza00AAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="l2fwd MAC address"
        title=""
        src="/static/6fc2fd40ba12ee1e45b9e7514623bff9/0ff56/l2fwd.png"
        srcset="/static/6fc2fd40ba12ee1e45b9e7514623bff9/222b7/l2fwd.png 163w,
/static/6fc2fd40ba12ee1e45b9e7514623bff9/ff46a/l2fwd.png 325w,
/static/6fc2fd40ba12ee1e45b9e7514623bff9/0ff56/l2fwd.png 407w"
        sizes="(max-width: 407px) 100vw, 407px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<ul>
<li><strong>Start pktgen-dpdk on the generator with Lua script:</strong> Get the MAC address of the ports by starting the l2fwd application on the SUT. Set them as the destination MAC address for the ports 0 and 2 in pktgen through the Lua script shown below.</li>
</ul>
<deckgo-highlight-code language="lua"  >
          <code slot="code">local port0 = &quot;0&quot;;
local port2 = &quot;2&quot;;

local port0_mac = &quot;3C:FD:FE:7C:BC:E0&quot;;
local port2_mac = &quot;3C:FD:FE:7C:BC:E2&quot;;

pktgen.set_mac(port0, &quot;dst&quot;, port0_mac);
pktgen.set_mac(port2, &quot;dst&quot;, port2_mac);

-- code for taking user input for packet size and rate
-- setting the packet size &amp; rate

pktgen.start(port0);
pktgen.start(port2);

-- code to check time to run

pktgen.stop(port0);
pktgen.stop(port2);</code>
        </deckgo-highlight-code>
<h3>l3fwd</h3>
<p>A layer 3 forwarder matches the destination IP of an incoming packet to the entries stored in its forwarding table and updates the layer 2 header before sending the packet to the next-hop.</p>
<h3>Longest Prefix Match</h3>
<p>For the LPM method, an LPM object is used to emulate the forwarding stage for IPv4 packets. The LPM object is used as the routing table to identify the next hop for each input packet at runtime. The example can be run with the following command on the SUT.</p>
<deckgo-highlight-code   >
          <code slot="code">sudo ./${RTE_SDK}/examples/l3fwd/${RTE_TARGET}/app/l3fwd -c 0x55 -n 4 -- -P -p 0xf --config=(0,0,0),(1,0,2),(2,0,4),(3,0,6)</code>
        </deckgo-highlight-code>
<p>The IP addresses obtained from the <a href="https://github.com/DPDK/dpdk/blob/466032ef8012a7fddd8dda986c5977e9341e3c35/examples/l3fwd/l3fwd_lpm.c#L46" target="_blank" rel="nofollow">source code</a> of l3fwd are set as shown below.</p>
<deckgo-highlight-code language="lua"  >
          <code slot="code">local port0 = &quot;0&quot;;
local port1 = &quot;1&quot;;
local port2 = &quot;2&quot;;
local port3 = &quot;3&quot;;

pktgen.set_ipaddr(port0, &quot;dst&quot;, &quot;198.18.1.1&quot;);
pktgen.set_ipaddr(port0, &quot;src&quot;, &quot;198.18.0.1&quot;);
pktgen.set_ipaddr(port1, &quot;dst&quot;, &quot;198.18.0.1&quot;);
pktgen.set_ipaddr(port1, &quot;src&quot;, &quot;198.18.1.1&quot;);

pktgen.set_ipaddr(port2, &quot;dst&quot;, &quot;198.18.3.1&quot;);
pktgen.set_ipaddr(port2, &quot;src&quot;, &quot;198.18.2.1&quot;);
pktgen.set_ipaddr(port3, &quot;dst&quot;, &quot;198.18.2.1&quot;);
pktgen.set_ipaddr(port3, &quot;src&quot;, &quot;198.18.3.1&quot;);

-- code for taking input of packet size, rate from the user
-- setting the packet size &amp; rate

pktgen.start(port0);
pktgen.start(port2);

-- code to check time to run

pktgen.stop(port0);
pktgen.stop(port2);</code>
        </deckgo-highlight-code>
<h3>Exact Match</h3>
<p>In the exact match lookup method, the forwarding is based on a hash for which a hash object is used to emulate the flow classification stage. The example can be run with the following command on the SUT. The -E parameter selects the exact match method.</p>
<deckgo-highlight-code   >
          <code slot="code">sudo ./${RTE_SDK}/examples/l3fwd/${RTE_TARGET}/app/l3fwd -c 0x55 -n 4 -- -P -E --parse-ptype -p 0xf --config=(0,0,0),(1,0,2),(2,0,4),(3,0,6)</code>
        </deckgo-highlight-code>
<p>From the code for the l3fwd application, the exact match works only with TCP packets and thus we set the protocol as TCP in the packets generated from pktgen. The exact match is based on the combination of IP addresses and port numbers, as seen in the routing table in the code. We set the IP addresses and destination and source ports as shown below obtained from the <a href="https://github.com/DPDK/dpdk/blob/466032ef8012a7fddd8dda986c5977e9341e3c35/examples/l3fwd/l3fwd_em.c#L102" target="_blank" rel="nofollow">source code</a>.</p>
<deckgo-highlight-code language="lua"  >
          <code slot="code">local port0 = &quot;0&quot;;
local port1 = &quot;1&quot;;
local port2 = &quot;2&quot;;
local port3 = &quot;3&quot;;

pktgen.set_ipaddr(port0, &quot;dst&quot;, &quot;201.0.0.0&quot;);
pktgen.set_ipaddr(port0, &quot;src&quot;, &quot;200.20.0.1&quot;);
pktgen.set_ipaddr(port1, &quot;dst&quot;, &quot;101.0.0.0&quot;);
pktgen.set_ipaddr(port1, &quot;src&quot;, &quot;100.10.0.1&quot;);

pktgen.set_ipaddr(port2, &quot;dst&quot;, &quot;211.0.0.0&quot;);
pktgen.set_ipaddr(port2, &quot;src&quot;, &quot;200.40.0.1&quot;);
pktgen.set_ipaddr(port3, &quot;dst&quot;, &quot;111.0.0.0&quot;);
pktgen.set_ipaddr(port3, &quot;src&quot;, &quot;100.30.0.1&quot;);

pktgen.set(port0, &quot;sport&quot;, 12);
pktgen.set(port0, &quot;dport&quot;, 102);
pktgen.set(port1, &quot;sport&quot;, 11);
pktgen.set(port1, &quot;dport&quot;, 101);

pktgen.set(port2, &quot;sport&quot;, 12);
pktgen.set(port2, &quot;dport&quot;, 102);
pktgen.set(port3, &quot;sport&quot;, 11);
pktgen.set(port3, &quot;dport&quot;, 101);

-- code for taking input of packet size, rate from the user
-- setting the packet size &amp; rate

pktgen.set_proto(&quot;all&quot;, &quot;tcp&quot;);

pktgen.start(port0);
pktgen.start(port2);

-- code to check time to run

pktgen.stop(port0);
pktgen.stop(port2);
</code>
        </deckgo-highlight-code>
<h3>l3fwd-power</h3>
<p>The L3 Forwarding with Power Management application is an example of power-aware packet processing using the DPDK. The example can be run with the following command on the SUT.</p>
<deckgo-highlight-code   >
          <code slot="code">sudo ./${RTE_SDK}/examples/l3fwd-power/${RTE_TARGET}/app/l3fwd-power -c 0x55 -n 4 -- -P -p 0xf --config=(0,0,0),(1,0,2),(2,0,4),(3,0,6)</code>
        </deckgo-highlight-code>
<p>The flow configured on pktgen with IP addresses can be done as below. The IP addresses are obtained from the <a href="https://github.com/DPDK/dpdk/blob/466032ef8012a7fddd8dda986c5977e9341e3c35/examples/l3fwd-power/main.c#L339" target="_blank" rel="nofollow">source code</a> of l3fwd-power. It runs the longest prefix match by default.</p>
<deckgo-highlight-code language="lua"  >
          <code slot="code">local port0 = &quot;0&quot;;
local port1 = &quot;1&quot;;
local port2 = &quot;2&quot;;
local port3 = &quot;3&quot;;

pktgen.set_ipaddr(port0, &quot;dst&quot;, &quot;1.1.1.1&quot;);
pktgen.set_ipaddr(port0, &quot;src&quot;, &quot;2.1.1.1&quot;);
pktgen.set_ipaddr(port1, &quot;dst&quot;, &quot;2.1.1.1&quot;);
pktgen.set_ipaddr(port1, &quot;src&quot;, &quot;1.1.1.1&quot;);

pktgen.set_ipaddr(port2, &quot;dst&quot;, &quot;4.1.1.1&quot;);
pktgen.set_ipaddr(port2, &quot;src&quot;, &quot;3.1.1.1&quot;);
pktgen.set_ipaddr(port3, &quot;dst&quot;, &quot;3.1.1.1&quot;);
pktgen.set_ipaddr(port3, &quot;src&quot;, &quot;4.1.1.1&quot;);

pktgen.set(port0, &quot;sport&quot;, 12);
pktgen.set(port0, &quot;dport&quot;, 102);
pktgen.set(port1, &quot;sport&quot;, 11);
pktgen.set(port1, &quot;dport&quot;, 101);

pktgen.set(port2, &quot;sport&quot;, 12);
pktgen.set(port2, &quot;dport&quot;, 102);
pktgen.set(port3, &quot;sport&quot;, 11);
pktgen.set(port3, &quot;dport&quot;, 101);

-- code for taking input of packet size, rate from the user
-- setting the packet size &amp; rate

pktgen.set_proto(&quot;all&quot;, &quot;tcp&quot;);

pktgen.start(port0);
pktgen.start(port2);

-- code to check time to run

pktgen.stop(port0);
pktgen.stop(port2);</code>
        </deckgo-highlight-code>
<h2>Conclusions</h2>
<p>In this article, we looked at running various forwarding applications of DPDK with pktgen-dpdk as the traffic generator with four ports. The main challenge we faced while trying to run these applications was a lack of proper documentation in setting up various cases with pktgen and making sure the traffic forwards on the application and reaches back to the other port. If you do not configure the IP/MAC address properly, it is possible that the packets do not reach the other port but come back on the same port. We hope with this blog, you'll be able to configure your flows with ease.</p>
<p>Both DPDK and pktgen-dpdk require a bit of work to set up and understand how the applications work, and undoubtedly there is a good learning curve. The DPDK documentation is quite detailed on running the DPDK applications and thus, we've not gone much into deep covering it but concentrated on pktgen-dpdk.</p>
<p>The complete Lua scripts can be found <a href="https://gist.github.com/mishal23/f16dd3fde15695b18d8a52dc11dd8cf0" target="_blank" rel="nofollow">here</a></p>
<h2>Acknowledgment</h2>
<p>We thank our project guide, <a href="https://www.linkedin.com/in/mohittahiliani/" target="_blank" rel="nofollow">Dr. Mohit P. Tahiliani</a>, and mentor Leslie Monis for their continuous guidance throughout the course of the project and our project teammate <a href="https://github.com/vachhanihpavan/" target="_blank" rel="nofollow">Pavan Vachhani</a> for his valuable contribution to the final project.</p>
<h2>References</h2>
<ul>
<li>DPDK Sample Application Guide: <a href="https://doc.dpdk.org/guides/sample_app_ug/l2_forward_real_virtual.html" target="_blank" rel="nofollow">l2fwd</a>, <a href="https://doc.dpdk.org/guides/sample_app_ug/l3_forward.html" target="_blank" rel="nofollow">l3fwd</a>, <a href="https://doc.dpdk.org/guides/sample_app_ug/l3_forward_power_man.html" target="_blank" rel="nofollow">l3fwd-power</a></li>
<li><a href="https://pktgen-dpdk.readthedocs.io/en/latest/getting_started.html" target="_blank" rel="nofollow">Pktgen-DPDK</a></li>
<li>DPDK Source Code: <a href="https://github.com/DPDK/dpdk" target="_blank" rel="nofollow">https://github.com/DPDK/dpdk</a></li>
</ul></div><span class="disqus-comment-count" data-disqus-identifier="https://mishal.dev/*" data-disqus-url="https://mishal.dev/*">...</span><div id="disqus_thread"></div></div></div></section><footer class="footer">Made with <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" color="red" style="color:red" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3 0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"></path></svg> by <a href="/">Mishal Shah</a><ul class="social"><li><a href="mailto:shahmishal1998@gmail.com" target="_blank" rel="noopener noreferrer"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" class="social-icons" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V400c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5 0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"></path></svg></a></li><li><a href="https://github.com/mishal23" target="_blank" rel="noopener noreferrer"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 496 512" class="social-icons" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a></li><li><a href="https://www.linkedin.com/in/mishal23/" target="_blank" rel="noopener noreferrer"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 448 512" class="social-icons" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></a></li><li><a href="https://twitter.com/1998Mishal" target="_blank" rel="noopener noreferrer"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" class="social-icons" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></a></li><li><a href="https://t.me/mishal23" target="_blank" rel="noopener noreferrer"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 448 512" class="social-icons" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M446.7 98.6l-67.6 318.8c-5.1 22.5-18.4 28.1-37.3 17.5l-103-75.9-49.7 47.8c-5.5 5.5-10.1 10.1-20.7 10.1l7.4-104.9 190.9-172.5c8.3-7.4-1.8-11.5-12.9-4.1L117.8 284 16.2 252.2c-22.1-6.9-22.5-22.1 4.6-32.7L418.2 66.4c18.4-6.9 34.5 4.1 28.5 32.2z"></path></svg></a></li></ul></footer></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-110715968-2"></script><script>
      
      
      if(true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-110715968-2', {"send_page_view":false});
      }
      </script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/running-dpdk-with-pktgen/";/*]]>*/</script><!-- slice-start id="_gatsby-scripts-1" -->
          <script
            id="gatsby-chunk-mapping"
          >
            window.___chunkMapping="{\"app\":[\"/app-ba3f7ecad36bfae7db89.js\"],\"component---cache-caches-gatsby-plugin-offline-app-shell-js\":[\"/component---cache-caches-gatsby-plugin-offline-app-shell-js-77a5baf7067fcbf0afaf.js\"],\"component---src-components-blog-post-js\":[\"/component---src-components-blog-post-js-92cae378ab7ba6a11d11.js\"],\"component---src-pages-404-js\":[\"/component---src-pages-404-js-fafc881eaf7748f1a0c2.js\"],\"component---src-pages-contact-js\":[\"/component---src-pages-contact-js-e69eb90ef2cf2f7e4973.js\"],\"component---src-pages-index-js\":[\"/component---src-pages-index-js-1443e4a095ae97c01297.js\"],\"component---src-pages-newsletter-js\":[\"/component---src-pages-newsletter-js-b5eb7b65ac02521227b8.js\"]}";
          </script>
        <script>window.___webpackCompilationHash="e03408bbfb69aabe242b";</script><script src="/webpack-runtime-5681c1d38c10815934b9.js" async></script><script src="/framework-60293074edda326fe89d.js" async></script><script src="/app-ba3f7ecad36bfae7db89.js" async></script><!-- slice-end id="_gatsby-scripts-1" --></body></html>